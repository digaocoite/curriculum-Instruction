<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>The Biliteracy Quest</title>
  <style>
    :root{
      --mizzou-gold:#F1B82D;
      --mizzou-black:#000000;
      --ink:#111;
      --paper:#ffffff;
      --soft:#f6f6f8;
      --soft2:#f1f3f7;
      --muted:#5b616e;
      --line:#e6e7eb;
      --success:#0b7a3b;
      --accent:#1b1b1b;
      --shadow: 0 12px 30px rgba(0,0,0,.10);
      --shadow2: 0 10px 22px rgba(0,0,0,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 10% 0%, rgba(241,184,45,.22), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(0,0,0,.10), transparent 55%),
        linear-gradient(180deg, #fff 0%, #fbfbfd 60%, #fff 100%);
      min-height:100vh;
    }
    .wrap{max-width:1180px; margin:0 auto; padding:22px 18px 40px;}
    .topbar{
      display:flex; gap:16px; align-items:stretch; justify-content:space-between;
      padding:16px; border-radius:var(--radius);
      background:linear-gradient(135deg, rgba(0,0,0,.95), rgba(0,0,0,.86));
      color:#fff; box-shadow:var(--shadow);
      border:1px solid rgba(241,184,45,.35);
    }
    .brand{display:flex; flex-direction:column; gap:6px;}
    .brand h1{
      margin:0; font-size:20px; letter-spacing:.2px;
      display:flex; gap:10px; align-items:center; line-height:1.15;
    }
    .badgeLogo{
      width:34px; height:34px; border-radius:12px;
      background:conic-gradient(from 180deg, var(--mizzou-gold), #ffd86a, var(--mizzou-gold));
      display:grid; place-items:center; color:#000; font-weight:900;
      box-shadow:0 10px 20px rgba(241,184,45,.22);
    }
    .brand p{margin:0; color:rgba(255,255,255,.78); font-size:13px; max-width:560px;}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:#fff; padding:10px 12px; border-radius:14px;
      font-weight:650; font-size:13px; cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      transition:transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.12)}
    .btn:active{transform:translateY(1px)}
    .btnGold{
      background:linear-gradient(180deg, var(--mizzou-gold), #e9ab10);
      color:#111; border-color:rgba(0,0,0,.12);
    }
    .btnGold:hover{background:linear-gradient(180deg, #ffd35f, var(--mizzou-gold))}
    .btnGhost{background:transparent}
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
      .actions{justify-content:flex-start}
    }
    .card{
      background:var(--paper);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, #fff, var(--soft));
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .cardHeader h2{margin:0; font-size:15px;}
    .cardBody{padding:16px;}
    .playerPanel{display:flex; flex-direction:column; gap:10px;}
    .statRow{display:flex; gap:10px; flex-wrap:wrap;}
    .stat{
      flex:1;
      min-width:140px;
      background:linear-gradient(180deg, #fff, var(--soft));
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
    }
    .stat .k{font-size:11px; color:var(--muted); margin-bottom:6px;}
    .stat .v{font-size:16px; font-weight:800;}
    .progressWrap{
      margin-top:2px;
      height:10px; background:var(--soft2); border-radius:999px; overflow:hidden;
      border:1px solid var(--line);
    }
    .progressBar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, var(--mizzou-gold), #ffd86a);
      transition:width .35s ease;
    }
    .tiny{font-size:12px; color:var(--muted); margin:0;}

    .questMap{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
      padding:14px 16px;
      background:linear-gradient(180deg, #fff, var(--soft));
      border-bottom:1px solid var(--line);
    }
    @media (max-width: 680px){
      .questMap{grid-template-columns:1fr; }
    }
    .checkpoint{
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      padding:10px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer;
      transition:transform .08s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .checkpoint:hover{border-color:#d6d7dc; box-shadow:0 10px 20px rgba(0,0,0,.06)}
    .checkpoint:active{transform:translateY(1px)}
    .checkpoint .left{display:flex; align-items:center; gap:10px;}
    .bubble{
      width:28px; height:28px; border-radius:12px;
      display:grid; place-items:center;
      background:rgba(241,184,45,.18);
      border:1px solid rgba(241,184,45,.35);
      font-weight:900;
    }
    .checkpoint.done .bubble{background:rgba(11,122,59,.14); border-color:rgba(11,122,59,.35)}
    .checkpoint.active{border-color:rgba(241,184,45,.55)}
    .checkpoint small{color:var(--muted)}
    .checkMark{font-weight:900; color:var(--success); display:none;}
    .checkpoint.done .checkMark{display:inline}

    .missions{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
    }
    @media (max-width: 680px){
      .missions{grid-template-columns:1fr;}
    }
    .mission{
      border-radius:18px;
      border:1px solid var(--line);
      background:linear-gradient(180deg,#fff,var(--soft));
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:230px;
    }
    .missionTop{
      padding:12px 12px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .missionTitle{margin:0; font-size:14px; font-weight:900;}
    .tagRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
    .tag{
      font-size:11px; padding:6px 8px; border-radius:999px;
      background:rgba(0,0,0,.06); color:#222; border:1px solid rgba(0,0,0,.07);
    }
    .tagGold{background:rgba(241,184,45,.22); border-color:rgba(241,184,45,.40)}
    .tagDark{background:rgba(0,0,0,.08)}
    .tagGreen{background:rgba(11,122,59,.12); border-color:rgba(11,122,59,.24)}
    .missionArt{
      height:110px;
      margin:0 12px 10px;
      border-radius:16px;
      background:
        radial-gradient(180px 120px at 20% 35%, rgba(241,184,45,.55), transparent 60%),
        radial-gradient(220px 140px at 80% 10%, rgba(0,0,0,.18), transparent 65%),
        linear-gradient(135deg, rgba(0,0,0,.92), rgba(0,0,0,.72));
      border:1px solid rgba(241,184,45,.25);
      position:relative;
      overflow:hidden;
    }
    .missionArt .emoji{
      position:absolute; inset:auto 14px 12px auto;
      font-size:34px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.45));
    }
    .missionArt .sigil{
      position:absolute; left:14px; top:14px;
      width:42px; height:42px; border-radius:16px;
      background:conic-gradient(from 180deg, var(--mizzou-gold), #ffd86a, var(--mizzou-gold));
      display:grid; place-items:center; font-weight:1000; color:#000;
      box-shadow:0 12px 26px rgba(241,184,45,.20);
    }
    .missionArt .caption{
      position:absolute; left:14px; bottom:14px; right:14px;
      color:rgba(255,255,255,.88);
      font-size:12px;
      line-height:1.3;
    }
    .missionBottom{
      padding:0 12px 12px;
      margin-top:auto;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .difficulty{font-size:12px; color:var(--muted); display:flex; align-items:center; gap:8px;}
    .stars{letter-spacing:2px; color:var(--mizzou-gold); text-shadow:0 8px 14px rgba(241,184,45,.15);}

    .panel{
      border:1px solid var(--line);
      border-radius:18px;
      background:#fff;
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, #fff, var(--soft));
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .panelHeader h3{margin:0; font-size:14px;}
    .panelBody{padding:16px;}
    .scene{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      margin-bottom:14px;
    }
    @media (max-width: 860px){
      .scene{grid-template-columns:1fr;}
    }
    .sceneBox{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:linear-gradient(180deg,#fff,var(--soft));
    }
    .sceneBox h4{margin:0 0 8px; font-size:13px;}
    .sceneBox p{margin:0; color:#222; line-height:1.45; font-size:13px;}
    .artifact{
      border:1px solid rgba(241,184,45,.35);
      border-radius:16px;
      background:
        radial-gradient(160px 120px at 15% 20%, rgba(241,184,45,.35), transparent 65%),
        linear-gradient(135deg, #111, #2a2a2a);
      color:#fff;
      padding:12px;
      position:relative;
      min-height:130px;
      overflow:hidden;
    }
    .artifact .label{
      display:inline-flex; align-items:center; gap:8px;
      font-size:11px;
      padding:6px 8px;
      border:1px solid rgba(255,255,255,.18);
      border-radius:999px;
      background:rgba(255,255,255,.08);
    }
    .artifact .paper{
      margin-top:10px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      border-radius:14px;
      padding:10px;
      font-size:12px;
      line-height:1.35;
      color:rgba(255,255,255,.90);
      white-space:pre-wrap;
    }

    .choices{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      margin:12px 0 10px;
    }
    @media (max-width: 860px){
      .choices{grid-template-columns:1fr;}
    }
    .choice{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:#fff;
      cursor:pointer;
      transition:transform .08s ease, border-color .2s ease, box-shadow .2s ease, background .2s ease;
      display:flex; flex-direction:column; gap:10px;
      min-height:110px;
    }
    .choice:hover{border-color:rgba(241,184,45,.55); box-shadow:0 12px 20px rgba(0,0,0,.06); background:linear-gradient(180deg,#fff,rgba(241,184,45,.08))}
    .choice:active{transform:translateY(1px)}
    .choice .cap{font-weight:900; font-size:12px; display:flex; justify-content:space-between; gap:10px;}
    .choice .cap span{color:var(--muted); font-weight:800}
    .choice p{margin:0; font-size:12.5px; color:#222; line-height:1.35;}

    .resultGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 860px){
      .resultGrid{grid-template-columns:1fr;}
    }
    .result{
      border-radius:16px;
      border:1px solid var(--line);
      padding:12px;
      background:linear-gradient(180deg,#fff,var(--soft));
    }
    .result h4{margin:0 0 6px; font-size:12.5px}
    .result p{margin:0; color:#222; font-size:12.5px; line-height:1.4}
    .result .hint{margin-top:8px; color:var(--muted); font-size:12px}

    .lensRow{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; align-items:center;}
    .lensBtn{
      border-radius:999px;
      padding:8px 10px;
      border:1px solid rgba(241,184,45,.40);
      background:rgba(241,184,45,.18);
      cursor:pointer;
      font-weight:850;
      font-size:12px;
      display:inline-flex; gap:8px; align-items:center;
      transition:transform .08s ease, background .2s ease;
    }
    .lensBtn:hover{background:rgba(241,184,45,.25)}
    .lensBtn:active{transform:translateY(1px)}
    .lensPop{
      margin-top:10px;
      border:1px solid rgba(241,184,45,.40);
      background:linear-gradient(180deg, rgba(241,184,45,.14), rgba(241,184,45,.06));
      border-radius:16px;
      padding:12px;
      display:none;
    }
    .lensPop strong{display:block; margin-bottom:6px}
    .lensPop ul{margin:0; padding-left:18px; color:#222; font-size:12.5px; line-height:1.45}
    .lensPop li{margin:4px 0}

    .inputBox{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      resize:vertical;
      min-height:90px;
      font-size:13px;
      line-height:1.4;
      outline:none;
    }
    textarea:focus{border-color:rgba(241,184,45,.60); box-shadow:0 0 0 4px rgba(241,184,45,.18)}
    .row{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-top:10px;
    }
    .note{font-size:12px; color:var(--muted); margin:0;}
    .pill{
      border-radius:999px; padding:7px 10px;
      border:1px solid var(--line);
      background:linear-gradient(180deg,#fff,var(--soft));
      font-size:12px;
      display:inline-flex; gap:8px; align-items:center;
    }

    .spellbook{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
    }
    @media (max-width: 680px){
      .spellbook{grid-template-columns:1fr;}
    }
    .spell{
      border:1px solid var(--line);
      border-radius:18px;
      background:#fff;
      overflow:hidden;
    }
    .spellTop{
      padding:12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      background:linear-gradient(180deg,#fff,var(--soft));
      border-bottom:1px solid var(--line);
    }
    .spellTop h4{margin:0; font-size:13px}
    .spellTop small{color:var(--muted)}
    .spellBody{padding:12px; display:none;}
    .spellBody p{margin:0; color:#222; font-size:12.5px; line-height:1.45}
    .spellBody ul{margin:10px 0 0; padding-left:18px; font-size:12.5px; line-height:1.45}
    .spellBody li{margin:4px 0}
    .spellActions{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;}
    .miniBtn{
      padding:8px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:linear-gradient(180deg,#fff,var(--soft));
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
    .miniBtn:hover{border-color:rgba(241,184,45,.55)}
    .miniBtnGold{
      border-color:rgba(241,184,45,.55);
      background:linear-gradient(180deg, rgba(241,184,45,.35), rgba(241,184,45,.18));
    }

    .log{
      border-top:1px solid var(--line);
      padding:12px 16px 16px;
      background:linear-gradient(180deg,#fff,var(--soft));
    }
    .log pre{
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      line-height:1.45;
    }
    .toast{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,.88);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(241,184,45,.35);
      box-shadow:var(--shadow);
      display:none;
      z-index:99;
      font-size:13px;
    }
    .canvasWrap{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(180deg,#fff,var(--soft));
      padding:12px;
      overflow:hidden;
    }
    canvas.postCanvas{
      width:100%;
      height:auto;
      display:block;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.10);
      background:#0b0b0d;
    }
    .canvasActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
      justify-content:space-between;
    }
    .helpRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:11px;
      border:1px solid var(--line);
      background:linear-gradient(180deg,#fff,var(--soft));
      border-radius:10px;
      padding:4px 8px;
      color:#111;
    }
    .hidden{display:none!important}
    .divider{height:1px; background:var(--line); margin:12px 0}
    .footerNote{
      margin-top:16px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(180deg,#fff,var(--soft));
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>
          <span class="badgeLogo">M</span>
          The Biliteracy Quest
        </h1>
        <p>
          Choose a mission, make decisions, and generate a Decision Path Scroll you can paste into Canvas.
        </p>
      </div>

      <div class="actions">
        <button type="button" class="btn btnGold" id="btnStart">Mission Hub</button>
        <button type="button" class="btn" id="btnSpellbook">Theory Spellbook</button>
        <button type="button" class="btn btnGhost" id="btnReset">Reset</button>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="cardMain">
        <div class="questMap" id="questMap">
          <div class="checkpoint active" data-step="0">
            <div class="left">
              <div class="bubble">1</div>
              <div>
                <div><b>Choose Mission</b></div>
                <small>Pick your challenge</small>
              </div>
            </div>
            <div class="checkMark">‚úì</div>
          </div>
          <div class="checkpoint" data-step="1">
            <div class="left">
              <div class="bubble">2</div>
              <div>
                <div><b>Face Scenario</b></div>
                <small>Decide, see outcomes</small>
              </div>
            </div>
            <div class="checkMark">‚úì</div>
          </div>
          <div class="checkpoint" data-step="2">
            <div class="left">
              <div class="bubble">3</div>
              <div>
                <div><b>Consult Theory</b></div>
                <small>Apply a lens</small>
              </div>
            </div>
            <div class="checkMark">‚úì</div>
          </div>
          <div class="checkpoint" data-step="3">
            <div class="left">
              <div class="bubble">4</div>
              <div>
                <div><b>Build Output</b></div>
                <small>Decision scroll</small>
              </div>
            </div>
            <div class="checkMark">‚úì</div>
          </div>
          <div class="checkpoint" data-step="4">
            <div class="left">
              <div class="bubble">5</div>
              <div>
                <div><b>Submit</b></div>
                <small>Copy into Canvas</small>
              </div>
            </div>
            <div class="checkMark">‚úì</div>
          </div>
        </div>

        <div class="cardBody" id="mainBody">
          <div id="screenMissions">
            <h2 style="margin:0 0 10px;">Mission Hub</h2>
            <p class="tiny" style="margin:0 0 14px;">
              Pick one mission. You‚Äôll complete 3 rounds. Save at least one justification to earn XP.
            </p>
            <div class="missions" id="missions"></div>
            <div class="footerNote">
              Tip: The best answers explain tradeoffs and connect decisions to theory, not ‚Äúperfect‚Äù choices.
            </div>
          </div>

          <div id="screenScenario" class="hidden">
            <div class="panel">
              <div class="panelHeader">
                <h3 id="scenarioTitle">Scenario</h3>
                <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                  <div class="pill" id="roundPill">Round 1 of 3</div>
                  <div class="pill" id="runTimerPill">‚è± 00:00</div>
                  <div class="pill" id="streakPill">Streak 0</div>
                </div>
              </div>

              <div class="panelBody">
                <div class="scene">
                  <div class="sceneBox">
                    <h4>Story Scene</h4>
                    <p id="scenarioScene"></p>
                  </div>
                  <div class="artifact">
                    <div class="label">Classroom artifact</div>
                    <div class="paper" id="scenarioArtifact"></div>
                  </div>
                </div>

                <div>
                  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                    <div>
                      <b id="decisionPrompt">Decision Point</b>
                      <div class="tiny" id="decisionHint">Choose one action</div>
                    </div>
                    <div class="pill">Earn XP by saving a justification</div>
                  </div>

                  <div class="choices" id="choices"></div>

                  <div id="resultArea" class="hidden">
                    <div class="resultGrid">
                      <div class="result">
                        <h4>Outcome</h4>
                        <p id="outcomeText"></p>
                        <div class="hint" id="tradeoffText"></div>
                      </div>
                      <div class="result">
                        <h4>Theory Lens Prompt</h4>
                        <p id="lensPrompt"></p>
                        <div class="lensRow">
                          <button type="button" class="lensBtn" id="btnShowLens">Open Lens Hints</button>
                          <button type="button" class="lensBtn" id="btnNext">Next Round</button>
                        </div>
                        <div class="lensPop" id="lensPop"></div>
                      </div>
                    </div>

                    <div class="inputBox">
                      <b>Justify your choice</b>
                      <p class="note">Write 3 to 6 sentences. Mention at least one author or course idea.</p>
                      <textarea id="justification" placeholder="Example: I chose option B because it supports oral rehearsal before writing, which aligns with Gibbons. It also increases access by creating structured participation pathways, which connects to Hornberger. A risk is time, so I would keep the oral step brief and use a visual organizer to bridge into writing."></textarea>
                      <div class="row">
                        <button type="button" class="btn btnGold" id="btnSaveJustification">Save justification and earn XP</button>
                        <span class="note" id="justificationStatus">Not saved yet</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="log">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                  <b>Decision Path Scroll</b>
                  <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button type="button" class="miniBtn" id="btnCopyLog">Copy scroll</button>
                    <button type="button" class="miniBtn" id="btnRenderPostInline">Update Canvas post image</button>
                    <button type="button" class="miniBtn miniBtnGold" id="btnFinish">Finish mission</button>
                  </div>
                </div>
                <div class="divider"></div>
                <pre id="logText">Pick a mission to begin.</pre>
              </div>
            </div>
          </div>

          <div id="screenSubmit" class="hidden">
            <div class="panel">
              <div class="panelHeader">
                <h3>Quest Complete</h3>
                <div class="pill" id="badgeSummary">Badges 0</div>
              </div>
              <div class="panelBody">
                <div class="sceneBox">
                  <h4>What to submit in Canvas</h4>
                  <ul style="margin:0; padding-left:18px; line-height:1.55; font-size:13px;">
                    <li>Paste your Decision Path Scroll</li>
                    <li>Paste one justification paragraph you wrote</li>
                    <li>Add 2 course citations or references to authors you used</li>
                    <li>Brief reflection: what you would do differently next time, and why</li>
                  </ul>
                </div>

                <div style="margin-top:12px;" class="sceneBox">
                  <h4>Copy everything</h4>
                  <p class="tiny" style="margin:0 0 10px;">This copy includes your scroll and any saved justification text.</p>
                  <button type="button" class="btn btnGold" id="btnCopyAll">Copy for Canvas</button>
                </div>

                <div class="canvasWrap">
                  <h4 style="margin:0 0 6px;">Canvas Post Image (your exact path)</h4>
                  <p class="tiny" style="margin:0 0 10px;">
                    This generates an image version of your run (mission, choices, outcomes, XP, badges). You can copy it or download it, then add it to a Canvas post.
                  </p>
                  <canvas id="postCanvas" class="postCanvas" width="1200" height="675" aria-label="Canvas post image preview"></canvas>
                  <div class="canvasActions">
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                      <button type="button" class="btn btnGold" id="btnCopyPostImage">Copy image</button>
                      <button type="button" class="btn" id="btnDownloadPostImage">Download PNG</button>
                      <button type="button" class="btn btnGhost" id="btnReRenderPost">Re-render</button>
                    </div>
                    <span class="note" id="postStatus">Ready</span>
                  </div>
                  <div class="helpRow">
                    <span class="pill"><span class="kbd">Tip</span> If ‚ÄúCopy image‚Äù is blocked, use ‚ÄúDownload PNG‚Äù and upload in Canvas.</span>
                    <span class="pill"><span class="kbd">Also</span> The text scroll is still best for accessibility.</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="screenSpellbook" class="hidden">
            <div class="panel">
              <div class="panelHeader">
                <h3>Theory Spellbook</h3>
                <div class="pill">Click a card to open</div>
              </div>
              <div class="panelBody">
                <div class="spellbook" id="spellbook"></div>
                <div class="footerNote">
                  Use these prompts to strengthen your justification. Focus on ‚Äúwhy this supports learning‚Äù and ‚Äúwho gains access.‚Äù
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <h2>Player Panel</h2>
          <span class="pill" id="levelPill">Level 1</span>
        </div>
        <div class="cardBody">
          <div class="playerPanel">
            <div class="statRow">
              <div class="stat">
                <div class="k">XP</div>
                <div class="v" id="xpVal">0</div>
              </div>
              <div class="stat">
                <div class="k">Badges</div>
                <div class="v" id="badgeVal">0</div>
              </div>
            </div>

            <div class="stat">
              <div class="k">Quest progress</div>
              <div class="progressWrap"><div class="progressBar" id="progressBar"></div></div>
              <p class="tiny" id="progressText" style="margin-top:8px;">Choose a mission to begin.</p>
            </div>

            <div class="stat">
              <div class="k">Unlocked badges</div>
              <div id="badgesList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
              <p class="tiny" style="margin-top:8px;">Badges unlock when you finish missions and connect decisions to theory.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Copied</div>

  <script>
    const STATE = {
      step: 0, xp: 0, badges: [],
      missionId: null, round: 0,
      decisionLog: [], savedJustifications: [], appliedSpells: [],
      runStartedAtMs: null,
      runEndedAtMs: null,
      streak: 0,
      runId: null
    };

    const SPELLS = [
      {
        id:"gibbons",
        title:"Gibbons: Scaffold Spell",
        subtitle:"Oral to written progression",
        body:[
          "Sequence supports: oral rehearsal, visual organization, then structured writing.",
          "Model, jointly construct, then release responsibility."
        ],
        prompts:[
          "How does your move build meaning before form?",
          "What scaffold makes academic language doable?",
          "How will you fade the scaffold over time?"
        ]
      },
      {
        id:"hornberger",
        title:"Hornberger: Access Charm",
        subtitle:"Identity, access, participation",
        body:[
          "Design multiple entry points for participation.",
          "Value linguistic resources and protect student voice."
        ],
        prompts:[
          "Who gains access with this choice? Who might still be excluded?",
          "How does the choice affirm multilingual identity and voice?",
          "What participation structure makes this equitable?"
        ]
      },
      {
        id:"multimodal",
        title:"Multimodality Mixer",
        subtitle:"Modes reinforce meaning",
        body:[
          "Pair oral, visual, and written modes to reduce cognitive load.",
          "Use visuals to externalize thinking (organizers, annotation, diagrams)."
        ],
        prompts:[
          "What visual element makes the next step clearer?",
          "How do modes connect rather than compete?",
          "What is the simplest multimodal combo that improves understanding?"
        ]
      },
      {
        id:"academic",
        title:"Academic Language Lens",
        subtitle:"Everyday to disciplinary",
        body:[
          "Teach language features as resources for meaning, not rules only.",
          "Connect vocabulary to function: explain, argue, compare, justify."
        ],
        prompts:[
          "Which feature supports clarity and evidence here?",
          "How will you keep student voice while increasing formality?",
          "What scaffold supports transfer to new tasks?"
        ]
      }
    ];

    // 4 playable missions, each with 3 rounds
    const MISSIONS = [
      {
        id: "bridge",
        title: "The Oral to Writing Bridge",
        emoji: "üåâ", sigil: "OW", difficulty: 2,
        tags: ["Gibbons","Scaffolding","Writing"],
        blurb: "Students speak well but struggle to write. Build a bridge from talk to text.",
        scenarioTitle: "Mission: The Oral to Writing Bridge",
        rounds: [
          {
            scene:"A glowing sign reads: Academic Paragraph Due. Students have strong ideas in discussion, but writing is short and vague. You have 45 minutes.",
            artifact:"Student line: ‚ÄúI like the university because is big. It is good.‚Äù\nTeacher note: Talk is richer than drafts.",
            prompt:"How do you start this lesson?",
            hint:"Pick a first move that builds meaning before drafting",
            lensHints:[
              "Gibbons: build meaning through talk before demanding written form.",
              "Hornberger: participation pathways and entry points matter.",
              "Ask: who benefits, who might be left out?"
            ],
            choices:[
              {label:"A",title:"Start writing immediately",text:"Draft right away with minimal scaffolding.",
               outcome:"Some write quickly, but many freeze or produce shallow sentences.",
               tradeoff:"Benefit: saves time. Risk: low access for students who need rehearsal or visuals.",
               lensPrompt:"How does this impact access and the shift from oral to written language?"},
              {label:"B",title:"Structured oral rehearsal",text:"Brief talk protocol with sentence starters.",
               outcome:"More participation; ideas and vocabulary emerge before drafting.",
               tradeoff:"Benefit: stronger meaning. Risk: time pressure later unless tight.",
               lensPrompt:"How does oral rehearsal support the oral-to-written progression and equitable participation?"},
              {label:"C",title:"Model paragraph spotlight",text:"Analyze a model paragraph for structure and features.",
               outcome:"Expectations become clearer; some may imitate without meaning.",
               tradeoff:"Benefit: clear target. Risk: form without voice unless guided.",
               lensPrompt:"How do you use models without replacing student meaning and identity?"}
            ]
          },
          {
            scene:"Students have ideas, but drafts still sound informal and repetitive. They need academic language without losing voice.",
            artifact:"Draft: ‚ÄúIt is good because good teachers.‚Äù\nPeer: ‚ÄúI don‚Äôt know more words.‚Äù",
            prompt:"What do you add before drafting again?",
            hint:"Choose a scaffold that supports academic language",
            lensHints:[
              "Use visuals to reduce cognitive load (organizers, color coding).",
              "Differentiate frames so they support rather than restrict.",
              "Keep meaning central: students choose their own examples."
            ],
            choices:[
              {label:"A",title:"Word bank + flexible sentence frames",text:"Targeted vocabulary and expandable frames.",
               outcome:"Writing becomes longer and clearer; more academic structures appear.",
               tradeoff:"Benefit: language support. Risk: formulaic writing if not personalized.",
               lensPrompt:"How do you keep frames supportive and still protect student voice?"},
              {label:"B",title:"Group drafting with roles",text:"Draft in groups to deepen ideas through talk.",
               outcome:"Ideas deepen; peer language support grows; participation can be uneven.",
               tradeoff:"Benefit: dialogic meaning-making. Risk: some voices disappear without structure.",
               lensPrompt:"What participation structure makes collaboration equitable?"},
              {label:"C",title:"Mini lesson on one writing feature",text:"Teach one feature (reasons/evidence), then apply.",
               outcome:"Writing gains focus; some need examples and visual support to apply well.",
               tradeoff:"Benefit: precision. Risk: overload if taught without a clear visual bridge.",
               lensPrompt:"What multimodal support bridges the concept into writing?"}
            ]
          },
          {
            scene:"Drafts exist. Students think revision means spelling only. You want critique, reasoning, and stronger evidence.",
            artifact:"Peer feedback: ‚ÄúGood.‚Äù\nStudent: ‚ÄúDo I just fix spelling?‚Äù",
            prompt:"How do you structure revision for critical thinking?",
            hint:"Choose a move that makes revision about meaning, evidence, clarity",
            lensHints:[
              "Revision = evaluating meaning + strengthening claims, not just editing.",
              "Make criteria visible: examples, checklists, and modeled decisions.",
              "Use talk to rehearse revision explanations before rewriting."
            ],
            choices:[
              {label:"A",title:"Revision checklist with categories",text:"Meaning, evidence, organization, language, with examples.",
               outcome:"Students revise ideas and structure, not only mechanics.",
               tradeoff:"Benefit: clarity. Risk: needs modeling to be used well.",
               lensPrompt:"How does explicit criteria support academic language and transfer?"},
              {label:"B",title:"Structured peer review prompts",text:"Sentence starters + targeted questions for feedback.",
               outcome:"Feedback becomes substantive; students practice academic discourse.",
               tradeoff:"Benefit: dialogic learning. Risk: shallow feedback without guidance.",
               lensPrompt:"How does structured talk expand access and participation?"},
              {label:"C",title:"Quick teacher conferences",text:"1‚Äì2 minute conferences focusing on one revision goal.",
               outcome:"High impact feedback; not everyone gets equal time.",
               tradeoff:"Benefit: precision. Risk: access and scalability constraints.",
               lensPrompt:"How do you protect access when time is limited?"}
            ]
          }
        ],
        badges: ["Scaffold Architect","Access Advocate"]
      },

      {
        id: "maze",
        title: "The Reading Barrier Maze",
        emoji: "üß≠", sigil: "RB", difficulty: 3,
        tags: ["Reading","Comprehension","Bridges"],
        blurb: "A dense text blocks comprehension. Find bridges that support meaning and transfer.",
        scenarioTitle: "Mission: The Reading Barrier Maze",
        rounds: [
          {
            scene:"Students must read a dense academic text. Many can decode words but struggle to construct meaning and discuss it.",
            artifact:"Student note: ‚ÄúI read it but I don‚Äôt understand what it means.‚Äù",
            prompt:"How do you open the reading task?",
            hint:"Choose a move that builds a shared purpose for reading",
            lensHints:[
              "Multimodality can anchor meaning: visuals, headings, key terms.",
              "Access increases when the task has clear roles and supports.",
              "Meaning first, then language precision."
            ],
            choices:[
              {label:"A",title:"Cold read then quiz",text:"Students read silently and answer comprehension questions.",
               outcome:"A few succeed; many disengage or guess.",
               tradeoff:"Benefit: speed. Risk: low meaning-making and limited access.",
               lensPrompt:"What does this assume about prior knowledge and language resources?"},
              {label:"B",title:"Guided preview + purpose",text:"Preview headings, key terms, and set a purpose question.",
               outcome:"Students read with direction; comprehension improves.",
               tradeoff:"Benefit: clarity. Risk: needs a tight plan to avoid over-scaffolding.",
               lensPrompt:"How does this reduce cognitive load and support access?"},
              {label:"C",title:"Jigsaw roles + talk first",text:"Assign roles (summarizer, connector, questioner) before reading.",
               outcome:"Talk creates a reason to read; participation increases.",
               tradeoff:"Benefit: dialogic learning. Risk: uneven roles unless structured.",
               lensPrompt:"How do roles protect equitable participation?"}
            ]
          },
          {
            scene:"Students understand parts, but struggle to connect ideas across paragraphs. You want synthesis, not isolated facts.",
            artifact:"Student highlight: many words highlighted, little summary.",
            prompt:"How do you support synthesis?",
            hint:"Pick a visual or dialogic bridge across ideas",
            lensHints:[
              "Use a visual organizer to map relationships (claim, evidence, implication).",
              "Talk can rehearse synthesis before writing it.",
              "Keep the organizer simple and purposeful."
            ],
            choices:[
              {label:"A",title:"Concept map organizer",text:"Students map claims and evidence visually.",
               outcome:"Connections become visible; students synthesize more effectively.",
               tradeoff:"Benefit: strong meaning-making. Risk: can get messy without modeling.",
               lensPrompt:"How does a visual element support comprehension and biliteracy?"},
              {label:"B",title:"Sentence frames for synthesis",text:"Provide frames that require linking ideas (however, therefore).",
               outcome:"Students make connections in writing with clearer structure.",
               tradeoff:"Benefit: functional language. Risk: needs examples to avoid robotic use.",
               lensPrompt:"How do frames support academic function and student voice?"},
              {label:"C",title:"Teacher summary then discussion",text:"Teacher summarizes key points, then students discuss.",
               outcome:"More students can participate, but less independent synthesis occurs.",
               tradeoff:"Benefit: access. Risk: reduced student agency if overused.",
               lensPrompt:"Where is the balance between access support and learner agency?"}
            ]
          },
          {
            scene:"Now students must produce an analytic response. You want them to justify claims with evidence from the text.",
            artifact:"Student draft: ‚ÄúThe author is right.‚Äù (no evidence)",
            prompt:"How do you raise the level of critical thinking?",
            hint:"Choose a structure that forces evidence-based justification",
            lensHints:[
              "Make criteria visible: what counts as evidence and why.",
              "Use peer critique with prompts to demand justification.",
              "Require a ‚Äòwhy‚Äô and a ‚Äòbecause‚Äô supported by text."
            ],
            choices:[
              {label:"A",title:"Claim‚ÄìEvidence‚ÄìReasoning template",text:"Students fill a structured CER template.",
               outcome:"Evidence use improves; reasoning becomes explicit.",
               tradeoff:"Benefit: clarity. Risk: can feel constrained unless flexible.",
               lensPrompt:"How does structure support reasoning while still allowing voice?"},
              {label:"B",title:"Peer challenge protocol",text:"Peers must ask: ‚ÄúWhat‚Äôs your evidence?‚Äù and ‚ÄúWhy does it matter?‚Äù",
               outcome:"Students strengthen arguments; discussion becomes analytic.",
               tradeoff:"Benefit: dialogic critique. Risk: needs norms for respectful talk.",
               lensPrompt:"How does structured dialogue build critical thinking and participation?"},
              {label:"C",title:"Rubric exemplars",text:"Show two exemplar responses and analyze why one is stronger.",
               outcome:"Students internalize criteria and revise toward stronger evidence use.",
               tradeoff:"Benefit: clear target. Risk: may imitate unless asked to adapt.",
               lensPrompt:"How do exemplars support learning without producing copy-only responses?"}
            ]
          }
        ],
        badges: ["Barrier Breaker","Mode Mixer"]
      },

      {
        id: "puzzle",
        title: "The Participation Puzzle",
        emoji: "üó£Ô∏è", sigil: "PP", difficulty: 2,
        tags: ["Identity","Access","Dialogue"],
        blurb: "Some voices dominate and others disappear. Design equitable participation.",
        scenarioTitle: "Mission: The Participation Puzzle",
        rounds: [
          {
            scene:"In online discussions, a few students post early and dominate. Others post late or not at all. You want dialogic exchange, not isolated posts.",
            artifact:"Thread pattern: 5 students post 80% of replies; many posts are ‚ÄúI agree.‚Äù",
            prompt:"How do you redesign discussion to increase dialogue?",
            hint:"Choose a structure that produces back-and-forth exchange",
            lensHints:[
              "Participation structures are equity structures.",
              "Make interaction requirements visible and doable.",
              "Use prompts that force application, not opinion only."
            ],
            choices:[
              {label:"A",title:"Keep as-is, add word count",text:"Require 250 words and 2 replies.",
               outcome:"Posts get longer, but dialogue quality may not improve.",
               tradeoff:"Benefit: easy to implement. Risk: longer but still shallow interaction.",
               lensPrompt:"Why might more words not equal more thinking or access?"},
              {label:"B",title:"Role-based discussion circles",text:"Assign roles (connector, challenger, summarizer) weekly.",
               outcome:"Replies become purposeful and varied; more students have entry points.",
               tradeoff:"Benefit: higher dialogue quality. Risk: needs clear role guidance.",
               lensPrompt:"How do roles support equitable participation and identity safety?"},
              {label:"C",title:"Structured response prompts",text:"Require evidence-based replies with sentence starters.",
               outcome:"Replies become more analytic and tied to readings.",
               tradeoff:"Benefit: academic discourse. Risk: can feel rigid unless flexible.",
               lensPrompt:"How do you balance structure with student voice?"}
            ]
          },
          {
            scene:"Some students feel uncertain about language accuracy and avoid posting. You want access without lowering rigor.",
            artifact:"Student message: ‚ÄúI‚Äôm afraid my English/Spanish is not perfect, so I don‚Äôt post.‚Äù",
            prompt:"What support increases access and keeps rigor?",
            hint:"Choose a move that lowers risk but preserves thinking demands",
            lensHints:[
              "Access can mean multiple modalities: audio, visuals, bilingual resources.",
              "Rigor can be in reasoning, not perfect grammar.",
              "Normalize drafting and revision."
            ],
            choices:[
              {label:"A",title:"Allow audio replies with transcript",text:"Students can reply with short audio plus a transcript.",
               outcome:"Participation increases and ideas become richer.",
               tradeoff:"Benefit: access. Risk: needs clear instructions for accessibility.",
               lensPrompt:"How does multimodality increase access while supporting academic discourse?"},
              {label:"B",title:"Bilingual planning allowed",text:"Students can plan ideas bilingually, then post in target language.",
               outcome:"Stronger ideas and confidence; better content quality.",
               tradeoff:"Benefit: identity affirming. Risk: needs boundaries to meet course goals.",
               lensPrompt:"How does this align with biliteracy development and Hornberger?"},
              {label:"C",title:"Grammar-first requirement",text:"Students must have near-perfect language accuracy.",
               outcome:"Some improve accuracy; many participate less and focus on form over meaning.",
               tradeoff:"Benefit: accuracy focus. Risk: reduced access and reduced critical thinking.",
               lensPrompt:"What gets lost when form becomes the main gatekeeper?"}
            ]
          },
          {
            scene:"Now you want students to demonstrate critical thinking: challenge ideas, connect theory, and propose implications.",
            artifact:"Most replies: ‚ÄúGreat point!‚Äù with no citation or application.",
            prompt:"How do you raise the level of thinking?",
            hint:"Choose a move that forces theory-based application",
            lensHints:[
              "Require students to apply a theory lens, not just agree/disagree.",
              "Use a ‚Äúclaim + warrant‚Äù structure tied to readings.",
              "Make the grading criteria visible."
            ],
            choices:[
              {label:"A",title:"Theory lens requirement",text:"Each reply must apply one author and explain relevance.",
               outcome:"Replies become analytic and grounded in readings.",
               tradeoff:"Benefit: rigor. Risk: needs clear examples so it‚Äôs not name-dropping.",
               lensPrompt:"How do you turn theory into reasoning rather than citations only?"},
              {label:"B",title:"Peer critique protocol",text:"Students must respectfully challenge one assumption with evidence.",
               outcome:"Dialogue becomes real; students practice academic critique.",
               tradeoff:"Benefit: critical thinking. Risk: needs norms to protect community.",
               lensPrompt:"How do norms and structure support identity-safe critique?"},
              {label:"C",title:"Case application prompt",text:"Each student applies discussion ideas to a classroom case.",
               outcome:"Strong transfer and relevance; posts show applied reasoning.",
               tradeoff:"Benefit: application. Risk: needs a good case library or student choice.",
               lensPrompt:"How does application demonstrate deeper understanding and transfer?"}
            ]
          }
        ],
        badges: ["Access Advocate","Theory Tactician"]
      },

      {
        id: "remix",
        title: "The Multimodal Remix Room",
        emoji: "üéõÔ∏è", sigil: "MM", difficulty: 1,
        tags: ["Multimodality","Design","Online"],
        blurb: "Design a low-friction multimodal assessment that increases critical thinking.",
        scenarioTitle: "Mission: The Multimodal Remix Room",
        rounds: [
          {
            scene:"You need to replace a discussion tool with something simple but more engaging. The goal is dialogic exchange and multimodal meaning-making.",
            artifact:"Constraint: must be low-cost, easy to access, and clearly tied to course objectives.",
            prompt:"What is your base format?",
            hint:"Choose a format that supports interaction and multimodality",
            lensHints:[
              "Choose the smallest tech that achieves the learning goal.",
              "Multimodality should reduce friction, not add it.",
              "Make the interaction requirement explicit."
            ],
            choices:[
              {label:"A",title:"Canvas discussion only",text:"Text posts + replies in Canvas.",
               outcome:"Reliable and simple, but can become repetitive without structure.",
               tradeoff:"Benefit: access. Risk: low novelty and weak multimodality.",
               lensPrompt:"What design features would increase dialogue and critical thinking?"},
              {label:"B",title:"Image-annotated discussion",text:"Students annotate an image/diagram and respond.",
               outcome:"More concrete talk; meaning anchored to visuals.",
               tradeoff:"Benefit: multimodal meaning. Risk: needs clear prompts and accessibility (alt text).",
               lensPrompt:"How do visuals increase critical thinking rather than decoration?"},
              {label:"C",title:"Short audio micro-dialogue",text:"Students post short audio + key points in text.",
               outcome:"Richer expression and tone; more conversational dialogue.",
               tradeoff:"Benefit: access and engagement. Risk: needs structure and accessibility.",
               lensPrompt:"How do you ensure equitable participation and assessment clarity?"}
            ]
          },
          {
            scene:"You want critical thinking. Students must evaluate, compare, and justify, not just share opinions.",
            artifact:"Goal: students must use readings to make a decision and defend it.",
            prompt:"What thinking task do you require?",
            hint:"Choose a task that forces evaluation and justification",
            lensHints:[
              "Use compare/contrast, decision-making, critique, or redesign.",
              "Require evidence from readings and implications for practice.",
              "Make the criteria visible."
            ],
            choices:[
              {label:"A",title:"Compare two approaches",text:"Students compare two strategies and argue for one in context.",
               outcome:"Clear analytic structure; encourages evidence-based reasoning.",
               tradeoff:"Benefit: strong critical thinking. Risk: needs well-defined approaches or options.",
               lensPrompt:"How do you connect comparison to real teaching decisions?"},
              {label:"B",title:"Critique an example",text:"Students critique a sample activity and propose revisions.",
               outcome:"Students practice evaluation and redesign.",
               tradeoff:"Benefit: authentic design thinking. Risk: needs a good sample and guidance.",
               lensPrompt:"How does redesign show transfer and deeper understanding?"},
              {label:"C",title:"Create then justify",text:"Students create a mini plan and justify each design choice.",
               outcome:"High transfer and ownership; strong alignment to practice.",
               tradeoff:"Benefit: synthesis. Risk: time demands if not bounded.",
               lensPrompt:"How do you keep it bounded and still rigorous?"}
            ]
          },
          {
            scene:"Now you need a grading approach that rewards reasoning and multimodal design, not just polish.",
            artifact:"Student concern: ‚ÄúDo I lose points if my visuals aren‚Äôt fancy?‚Äù",
            prompt:"What grading criteria do you emphasize?",
            hint:"Choose criteria that reward thinking, not aesthetics",
            lensHints:[
              "Grade reasoning, alignment, and accessibility over visual flair.",
              "Include theory integration and clarity of interaction.",
              "Make expectations transparent."
            ],
            choices:[
              {label:"A",title:"Reasoning-first rubric",text:"Theory use + justification + alignment are highest weight.",
               outcome:"Students focus on thinking and application.",
               tradeoff:"Benefit: fairness. Risk: must define what counts as strong justification.",
               lensPrompt:"How do you describe excellent reasoning in student-friendly terms?"},
              {label:"B",title:"Design-first rubric",text:"Visual polish and creativity are highest weight.",
               outcome:"Some beautiful work; can disadvantage students with less design experience.",
               tradeoff:"Benefit: aesthetics. Risk: inequity and reduced focus on learning goals.",
               lensPrompt:"How does this choice affect access and participation?"},
              {label:"C",title:"Balanced rubric + accessibility",text:"Reasoning and design both matter; accessibility is required.",
               outcome:"Students build functional multimodal work and defend choices.",
               tradeoff:"Benefit: well-rounded. Risk: needs concise rubric language to avoid confusion.",
               lensPrompt:"How do you keep the rubric simple and aligned to objectives?"}
            ]
          }
        ],
        badges: ["Mode Mixer","Critical Connector"]
      }
    ];

    const el = (id) => document.getElementById(id);

    const missionsEl = el("missions");
    const screenMissions = el("screenMissions");
    const screenScenario = el("screenScenario");
    const screenSubmit = el("screenSubmit");
    const screenSpellbook = el("screenSpellbook");

    const questMap = el("questMap");
    const progressBar = el("progressBar");
    const progressText = el("progressText");
    const xpVal = el("xpVal");
    const badgeVal = el("badgeVal");
    const levelPill = el("levelPill");
    const badgesList = el("badgesList");

    const scenarioTitle = el("scenarioTitle");
    const roundPill = el("roundPill");
    const runTimerPill = el("runTimerPill");
    const streakPill = el("streakPill");
    const scenarioScene = el("scenarioScene");
    const scenarioArtifact = el("scenarioArtifact");
    const decisionPrompt = el("decisionPrompt");
    const decisionHint = el("decisionHint");
    const choicesEl = el("choices");

    const resultArea = el("resultArea");
    const outcomeText = el("outcomeText");
    const tradeoffText = el("tradeoffText");
    const lensPrompt = el("lensPrompt");
    const lensPop = el("lensPop");
    const btnShowLens = el("btnShowLens");
    const btnNext = el("btnNext");

    const justification = el("justification");
    const btnSaveJustification = el("btnSaveJustification");
    const justificationStatus = el("justificationStatus");

    const logText = el("logText");
    const btnCopyLog = el("btnCopyLog");
    const btnRenderPostInline = el("btnRenderPostInline");
    const btnFinish = el("btnFinish");

    const btnStart = el("btnStart");
    const btnSpellbook = el("btnSpellbook");
    const btnReset = el("btnReset");

    const spellbookEl = el("spellbook");

    const badgeSummary = el("badgeSummary");
    const btnCopyAll = el("btnCopyAll");

    const toast = el("toast");
    const postCanvas = el("postCanvas");
    const btnCopyPostImage = el("btnCopyPostImage");
    const btnDownloadPostImage = el("btnDownloadPostImage");
    const btnReRenderPost = el("btnReRenderPost");
    const postStatus = el("postStatus");

    let TIMER_TICK = null;

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(()=> toast.style.display="none", 1200);
    }

    function setStep(step){
      STATE.step = step;
      [...questMap.querySelectorAll(".checkpoint")].forEach(cp=>{
        const s = Number(cp.dataset.step);
        cp.classList.toggle("active", s === step);
        cp.classList.toggle("done", s < step);
      });

      const pct = (step / 4) * 100;
      progressBar.style.width = pct + "%";
      const labels = [
        "Choose a mission to begin.",
        "Make a decision and review outcomes.",
        "Consult theory to strengthen your justification.",
        "Build your decision path scroll.",
        "Copy and submit in Canvas."
      ];
      progressText.textContent = labels[step] || labels[0];
    }

    function updatePlayerPanel(){
      xpVal.textContent = STATE.xp;
      badgeVal.textContent = STATE.badges.length;
      const level = 1 + Math.floor(STATE.xp / 80);
      levelPill.textContent = "Level " + level;

      badgesList.innerHTML = "";
      if(STATE.badges.length === 0){
        const span = document.createElement("span");
        span.className = "tag tagDark";
        span.textContent = "None yet";
        badgesList.appendChild(span);
      } else {
        STATE.badges.forEach(b=>{
          const span = document.createElement("span");
          span.className = "tag tagGold";
          span.textContent = b;
          badgesList.appendChild(span);
        });
      }
    }

    function renderMissions(){
      missionsEl.innerHTML = "";
      MISSIONS.forEach(m=>{
        const div = document.createElement("div");
        div.className = "mission";
        const stars = "‚òÖ".repeat(m.difficulty) + "‚òÜ".repeat(Math.max(0,3-m.difficulty));

        div.innerHTML = `
          <div class="missionTop">
            <div>
              <div class="missionTitle">${m.title}</div>
              <div class="tagRow">
                ${(m.tags||[]).slice(0,3).map(t=> `<span class="tag ${t==="Gibbons"||t==="Multimodality" ? "tagGold" : "tagDark"}">${t}</span>`).join("")}
              </div>
            </div>
            <div class="difficulty"><span class="stars">${stars}</span></div>
          </div>

          <div class="missionArt">
            <div class="sigil">${m.sigil}</div>
            <div class="emoji">${m.emoji}</div>
            <div class="caption">${m.blurb}</div>
          </div>

          <div class="missionBottom">
            <div class="difficulty"><span>Difficulty</span><span class="stars">${stars}</span></div>
            <button type="button" class="btn btnGold" data-mission="${m.id}">Play Mission</button>
          </div>
        `;
        missionsEl.appendChild(div);
      });

      missionsEl.querySelectorAll("button[data-mission]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-mission");
          startMission(id);
        });
      });
    }

    function currentMission(){
      return MISSIONS.find(m=> m.id === STATE.missionId);
    }
    function roundData(){
      const m = currentMission();
      if(!m) return null;
      return m.rounds[STATE.round];
    }

    function startMission(missionId){
      STATE.missionId = missionId;
      STATE.round = 0;
      STATE.decisionLog = [];
      STATE.savedJustifications = [];
      STATE.appliedSpells = [];
      STATE.streak = 0;
      STATE.runStartedAtMs = Date.now();
      STATE.runEndedAtMs = null;
      STATE.runId = makeRunId();

      setStep(1);
      screenMissions.classList.add("hidden");
      screenScenario.classList.remove("hidden");
      screenSubmit.classList.add("hidden");
      screenSpellbook.classList.add("hidden");

      renderRound();
      updateLog();
      updateRunHUD();
      updatePlayerPanel();
      startRunTimer();
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function renderRound(){
      const m = currentMission();
      const r = roundData();
      if(!m || !r) return;

      scenarioTitle.textContent = m.scenarioTitle;
      roundPill.textContent = "Round " + (STATE.round + 1) + " of " + m.rounds.length;
      streakPill.textContent = "Streak " + STATE.streak;

      scenarioScene.textContent = r.scene;
      scenarioArtifact.textContent = r.artifact;

      decisionPrompt.textContent = r.prompt;
      decisionHint.textContent = r.hint;

      choicesEl.innerHTML = "";
      resultArea.classList.add("hidden");
      lensPop.style.display = "none";
      justification.value = "";
      justificationStatus.textContent = "Not saved yet";

      r.choices.forEach((c, idx)=>{
        const div = document.createElement("div");
        div.className = "choice";
        div.innerHTML = `
          <div class="cap">${c.label}. ${c.title} <span>Choose</span></div>
          <p>${c.text}</p>
        `;
        div.addEventListener("click", ()=> selectChoice(idx));
        choicesEl.appendChild(div);
      });
    }

    function selectChoice(idx){
      const r = roundData();
      const m = currentMission();
      if(!r || !m) return;

      const c = r.choices[idx];

      outcomeText.textContent = c.outcome;
      tradeoffText.textContent = c.tradeoff;
      lensPrompt.textContent = c.lensPrompt;

      lensPop.innerHTML = `
        <strong>Lens Hints</strong>
        <ul>${r.lensHints.map(x=> `<li>${x}</li>`).join("")}</ul>
      `;

      resultArea.classList.remove("hidden");

      const entry = {
        round: STATE.round + 1,
        prompt: r.prompt,
        choice: `${c.label}. ${c.title}`,
        outcome: c.outcome,
        tradeoff: c.tradeoff
      };

      const existingIndex = STATE.decisionLog.findIndex(e=> e.round === entry.round);
      if(existingIndex >= 0) STATE.decisionLog[existingIndex] = entry;
      else STATE.decisionLog.push(entry);

      updateLog();

      btnShowLens.onclick = ()=>{
        lensPop.style.display = lensPop.style.display === "block" ? "none" : "block";
      };

      btnNext.onclick = ()=> goNextRound();

      btnSaveJustification.onclick = ()=> saveJustification(entry);
    }

    function containsTheory(text){
      const t = text.toLowerCase();
      return t.includes("gibbons") || t.includes("hornberger") || t.includes("multimodal") || t.includes("academic") || t.includes("scaffold");
    }

    function makeRunId(){
      // Friendly, short, non-identifying run id
      return Math.random().toString(36).slice(2, 6).toUpperCase() + "-" + Math.random().toString(36).slice(2, 6).toUpperCase();
    }

    function formatDuration(ms){
      const s = Math.max(0, Math.floor(ms / 1000));
      const mm = String(Math.floor(s / 60)).padStart(2,"0");
      const ss = String(s % 60).padStart(2,"0");
      return `${mm}:${ss}`;
    }

    function runElapsedMs(){
      if(!STATE.runStartedAtMs) return 0;
      const end = STATE.runEndedAtMs ?? Date.now();
      return Math.max(0, end - STATE.runStartedAtMs);
    }

    function updateRunHUD(){
      if(runTimerPill) runTimerPill.textContent = "‚è± " + formatDuration(runElapsedMs());
      if(streakPill) streakPill.textContent = "Streak " + STATE.streak;
    }

    function startRunTimer(){
      if(TIMER_TICK) clearInterval(TIMER_TICK);
      TIMER_TICK = setInterval(updateRunHUD, 400);
    }

    function stopRunTimer(){
      if(TIMER_TICK) clearInterval(TIMER_TICK);
      TIMER_TICK = null;
    }

    function addXP(amount){
      STATE.xp += amount;
      updatePlayerPanel();
    }

    function saveJustification(entry){
      const text = justification.value.trim();
      if(text.length < 40){
        showToast("Add a bit more detail first");
        return;
      }

      const saved = { round: entry.round, text };
      const i = STATE.savedJustifications.findIndex(x=> x.round === saved.round);
      if(i >= 0) STATE.savedJustifications[i] = saved;
      else STATE.savedJustifications.push(saved);

      const base = 20;
      const theoryBonus = containsTheory(text) ? 15 : 0;
      const streakBonus = Math.min(25, STATE.streak * 5);
      addXP(base + theoryBonus + streakBonus);

      STATE.streak += 1;
      updateRunHUD();

      justificationStatus.textContent = "Saved and XP earned";
      showToast("Saved");
      updateLog();
      renderCanvasPostSafe();
      setStep(Math.max(STATE.step, 2));
    }

    function goNextRound(){
      const m = currentMission();
      if(!m) return;

      if(STATE.round < m.rounds.length - 1){
        // If the player advances without saving this round‚Äôs justification,
        // the XP streak breaks (game-like feedback loop).
        const currentRoundNumber = STATE.round + 1;
        const savedThisRound = STATE.savedJustifications.some(j=> j.round === currentRoundNumber);
        if(!savedThisRound) {
          STATE.streak = 0;
          updateRunHUD();
        }

        STATE.round += 1;
        renderRound();
        updateLog();
        renderCanvasPostSafe();
        setStep(Math.max(STATE.step, 1));
      } else {
        finishMission();
      }
    }

    function finishMission(){
      const m = currentMission();
      if(!m) return;

      const usedTheory = STATE.savedJustifications.some(j => containsTheory(j.text));
      const badgePicks = [];
      badgePicks.push(m.badges?.[0] || "Quest Finisher");
      if(usedTheory) badgePicks.push(m.badges?.[1] || "Theory Tactician");

      badgePicks.forEach(b=>{
        if(!STATE.badges.includes(b)) STATE.badges.push(b);
      });

      addXP(30);
      updatePlayerPanel();

      STATE.runEndedAtMs = Date.now();
      stopRunTimer();
      updateRunHUD();
      recordBestRun();

      setStep(4);
      screenScenario.classList.add("hidden");
      screenSubmit.classList.remove("hidden");
      screenMissions.classList.add("hidden");
      screenSpellbook.classList.add("hidden");

      badgeSummary.textContent = "Badges " + STATE.badges.length;
      showToast("Quest complete");
      renderCanvasPostSafe();
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function recordBestRun(){
      try{
        const key = "biliteracyQuest_bestRun_v1";
        const best = JSON.parse(localStorage.getItem(key) || "null");
        const run = {
          xp: STATE.xp,
          badges: STATE.badges.length,
          missionId: STATE.missionId,
          durationMs: runElapsedMs(),
          endedAt: Date.now()
        };
        // Best = highest XP; tie-breaker = shorter time.
        const isBetter = !best || run.xp > best.xp || (run.xp === best.xp && run.durationMs < best.durationMs);
        if(isBetter) localStorage.setItem(key, JSON.stringify(run));
      } catch(_e){
        // ignore storage failures
      }
    }

    function estimateImpact(){
      // Lightweight ‚Äúreal game‚Äù feel: infer three meters from player-visible text.
      // Returns 0..100 values for Access / Rigor / Voice
      const text = [
        ...STATE.decisionLog.map(e=> `${e.choice} ${e.outcome} ${e.tradeoff}`),
        ...STATE.savedJustifications.map(j=> j.text),
        ...STATE.appliedSpells
      ].join(" ").toLowerCase();

      const score = (words) => words.reduce((acc,w)=> acc + (text.includes(w) ? 1 : 0), 0);
      const access = score(["access","equity","equitable","participation","entry point","include","excluded","identity","voice","multilingual"]);
      const rigor  = score(["evidence","reasoning","analytic","analysis","precision","academic","justify","transfer","criteria","rubric"]);
      const voice  = score(["dialogue","discussion","talk","rehearsal","peer","collaboration","critique","norms","reply"]);

      const clamp01 = (n) => Math.max(0, Math.min(1, n));
      // 0..1 normalized (soft caps)
      const a = clamp01(access / 10);
      const r = clamp01(rigor / 10);
      const v = clamp01(voice / 10);
      return { access: Math.round(a*100), rigor: Math.round(r*100), voice: Math.round(v*100) };
    }

    function updateLog(){
      const m = currentMission();
      const title = m ? m.title : "No mission selected";
      const lines = [];

      lines.push("THE BILITERACY QUEST ‚Äì DECISION PATH SCROLL");
      lines.push("Mission: " + title);
      if(STATE.runId) lines.push("Run ID: " + STATE.runId);
      if(STATE.runStartedAtMs) lines.push("Time: " + formatDuration(runElapsedMs()));
      lines.push("");

      if(STATE.decisionLog.length === 0){
        lines.push("Pick a mission and make a choice to generate your scroll.");
      } else {
        STATE.decisionLog
          .sort((a,b)=> a.round - b.round)
          .forEach(e=>{
            lines.push("Round " + e.round);
            lines.push("Prompt: " + e.prompt);
            lines.push("Choice: " + e.choice);
            lines.push("Outcome: " + e.outcome);
            lines.push("Tradeoff: " + e.tradeoff);
            lines.push("");
          });
      }

      if(STATE.savedJustifications.length){
        lines.push("SAVED JUSTIFICATION");
        STATE.savedJustifications
          .sort((a,b)=> a.round - b.round)
          .forEach(j=>{
            lines.push("Round " + j.round + " justification:");
            lines.push(j.text);
            lines.push("");
          });
      }

      if(STATE.appliedSpells.length){
        lines.push("APPLIED THEORY SPELLS");
        lines.push(STATE.appliedSpells.map(s=> "‚Ä¢ " + s).join("\n"));
        lines.push("");
      }

      const impact = estimateImpact();
      lines.push("IMPACT METERS (ESTIMATE)");
      lines.push("Access: " + impact.access + "/100");
      lines.push("Rigor: " + impact.rigor + "/100");
      lines.push("Voice: " + impact.voice + "/100");
      lines.push("");

      lines.push("XP: " + STATE.xp);
      lines.push("Badges: " + (STATE.badges.length ? STATE.badges.join(", ") : "None"));

      logText.textContent = lines.join("\n");
    }

    function copyText(text){
      // Clipboard API can fail on some contexts (e.g., file://). Provide a fallback.
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=> showToast("Copied")).catch(()=> fallbackCopy(text));
        return;
      }
      fallbackCopy(text);
    }

    function fallbackCopy(text){
      try{
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.setAttribute("readonly", "true");
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand("copy");
        ta.remove();
        showToast(ok ? "Copied" : "Copy failed");
      } catch(_e){
        showToast("Copy failed");
      }
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight, maxLines=Infinity){
      const words = (text || "").split(/\s+/).filter(Boolean);
      let line = "";
      let lines = 0;
      for(const word of words){
        const test = line ? line + " " + word : word;
        if(ctx.measureText(test).width > maxWidth && line){
          ctx.fillText(line, x, y);
          y += lineHeight;
          lines += 1;
          if(lines >= maxLines) return y;
          line = word;
        } else {
          line = test;
        }
      }
      if(line && lines < maxLines){
        ctx.fillText(line, x, y);
        y += lineHeight;
      }
      return y;
    }

    function drawPill(ctx, x, y, text, opts={}){
      const padX = opts.padX ?? 14;
      const padY = opts.padY ?? 9;
      const r = opts.radius ?? 16;
      ctx.font = opts.font ?? "700 22px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      const w = ctx.measureText(text).width + padX*2;
      const h = (opts.height ?? 40);
      ctx.save();
      ctx.fillStyle = opts.fill ?? "rgba(255,255,255,.10)";
      ctx.strokeStyle = opts.stroke ?? "rgba(241,184,45,.28)";
      ctx.lineWidth = 2;
      roundRect(ctx, x, y, w, h, r);
      ctx.fill();
      ctx.stroke();
      ctx.fillStyle = opts.color ?? "rgba(255,255,255,.92)";
      ctx.textBaseline = "middle";
      ctx.fillText(text, x + padX, y + h/2);
      ctx.restore();
      return {w, h};
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x + rr, y);
      ctx.arcTo(x + w, y, x + w, y + h, rr);
      ctx.arcTo(x + w, y + h, x, y + h, rr);
      ctx.arcTo(x, y + h, x, y, rr);
      ctx.arcTo(x, y, x + w, y, rr);
      ctx.closePath();
    }

    function renderCanvasPostSafe(){
      try{ renderCanvasPost(); }
      catch(_e){ /* ignore render failures */ }
    }

    function renderCanvasPost(){
      if(!postCanvas) return;
      const ctx = postCanvas.getContext("2d");
      if(!ctx) return;

      const W = postCanvas.width;
      const H = postCanvas.height;

      // Background
      ctx.clearRect(0,0,W,H);
      const bg = ctx.createLinearGradient(0,0,W,H);
      bg.addColorStop(0, "#070709");
      bg.addColorStop(.55, "#101014");
      bg.addColorStop(1, "#060608");
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,W,H);

      // Accents
      const glow = ctx.createRadialGradient(W*0.2, H*0.15, 10, W*0.2, H*0.15, H*0.8);
      glow.addColorStop(0, "rgba(241,184,45,.30)");
      glow.addColorStop(1, "rgba(241,184,45,0)");
      ctx.fillStyle = glow;
      ctx.fillRect(0,0,W,H);

      // Header
      const m = currentMission();
      const title = m ? m.title : "Biliteracy Quest";
      ctx.fillStyle = "rgba(255,255,255,.92)";
      ctx.font = "900 44px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.textBaseline = "top";
      ctx.fillText("THE BILITERACY QUEST", 56, 42);

      ctx.fillStyle = "rgba(255,255,255,.80)";
      ctx.font = "800 30px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillText("Mission: " + title, 56, 98);

      // Meta pills
      let px = 56, py = 148;
      const meta = [];
      if(STATE.runId) meta.push("Run " + STATE.runId);
      meta.push("Time " + formatDuration(runElapsedMs()));
      meta.push("XP " + STATE.xp);
      meta.push("Badges " + STATE.badges.length);
      meta.forEach((t)=>{
        const pill = drawPill(ctx, px, py, t);
        px += pill.w + 12;
      });

      // Main card
      const cardX = 56, cardY = 214, cardW = W - 112, cardH = H - 270;
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,.06)";
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 2;
      roundRect(ctx, cardX, cardY, cardW, cardH, 28);
      ctx.fill();
      ctx.stroke();
      ctx.restore();

      // Path timeline
      const path = [...STATE.decisionLog].sort((a,b)=> a.round - b.round);
      const left = cardX + 44;
      const top = cardY + 40;
      const right = cardX + cardW - 44;
      const lineX = left + 22;
      const rowGap = 120;

      // Vertical line
      ctx.save();
      ctx.strokeStyle = "rgba(241,184,45,.55)";
      ctx.lineWidth = 6;
      ctx.lineCap = "round";
      const lineTop = top + 18;
      const lineBot = top + Math.max(0, (path.length-1))*rowGap + 18;
      ctx.beginPath();
      ctx.moveTo(lineX, lineTop);
      ctx.lineTo(lineX, lineBot);
      ctx.stroke();
      ctx.restore();

      // Nodes + text
      ctx.textBaseline = "top";
      path.forEach((e, i)=>{
        const y = top + i*rowGap;

        // Node
        ctx.save();
        ctx.fillStyle = "#F1B82D";
        ctx.shadowColor = "rgba(241,184,45,.35)";
        ctx.shadowBlur = 18;
        ctx.beginPath();
        ctx.arc(lineX, y + 18, 16, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();

        ctx.save();
        ctx.fillStyle = "#111";
        ctx.font = "900 18px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(String(e.round), lineX, y + 18);
        ctx.restore();

        // Text block
        const tx = lineX + 34;
        const maxW = right - tx;
        ctx.fillStyle = "rgba(255,255,255,.92)";
        ctx.font = "900 24px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
        ctx.textAlign = "left";
        ctx.textBaseline = "top";
        ctx.fillText("Round " + e.round + " ‚Ä¢ " + e.choice, tx, y);

        ctx.fillStyle = "rgba(255,255,255,.80)";
        ctx.font = "650 18px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
        let yy = y + 34;
        yy = wrapText(ctx, "Outcome: " + e.outcome, tx, yy, maxW, 22, 2);
        ctx.fillStyle = "rgba(255,255,255,.66)";
        wrapText(ctx, "Tradeoff: " + e.tradeoff, tx, yy, maxW, 22, 2);
      });

      // Footer: badges + spells (as tags)
      const impact = estimateImpact();
      const footerY = cardY + cardH - 62;
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,.70)";
      ctx.font = "800 18px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.textBaseline = "middle";
      ctx.fillText("Impact: Access " + impact.access + " ‚Ä¢ Rigor " + impact.rigor + " ‚Ä¢ Voice " + impact.voice, cardX + 44, footerY);
      ctx.restore();

      // Small note for Canvas
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,.46)";
      ctx.font = "650 16px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.textBaseline = "bottom";
      ctx.fillText("Copy/paste or upload this image into Canvas. Text scroll recommended for accessibility.", 56, H - 22);
      ctx.restore();
    }

    async function copyPostImage(){
      if(!postCanvas) return;
      postStatus.textContent = "Copying‚Ä¶";
      renderCanvasPostSafe();
      const blob = await new Promise((resolve)=> postCanvas.toBlob(resolve, "image/png"));
      if(!blob){
        postStatus.textContent = "Could not render image";
        showToast("Copy failed");
        return;
      }
      try{
        if(navigator.clipboard && window.ClipboardItem){
          await navigator.clipboard.write([new ClipboardItem({"image/png": blob})]);
          postStatus.textContent = "Copied image";
          showToast("Copied");
          return;
        }
        // Fallback: download
        downloadBlob(blob, "biliteracy-quest-path.png");
        postStatus.textContent = "Downloaded (copy not supported)";
        showToast("Downloaded");
      } catch(_e){
        // Fallback: download
        downloadBlob(blob, "biliteracy-quest-path.png");
        postStatus.textContent = "Downloaded (clipboard blocked)";
        showToast("Downloaded");
      }
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 500);
    }

    async function downloadPostImage(){
      if(!postCanvas) return;
      postStatus.textContent = "Preparing download‚Ä¶";
      renderCanvasPostSafe();
      const blob = await new Promise((resolve)=> postCanvas.toBlob(resolve, "image/png"));
      if(!blob){
        postStatus.textContent = "Could not render image";
        return;
      }
      downloadBlob(blob, "biliteracy-quest-path.png");
      postStatus.textContent = "Downloaded PNG";
      showToast("Downloaded");
    }

    // Buttons
    btnCopyLog.addEventListener("click", ()=> copyText(logText.textContent));
    btnRenderPostInline.addEventListener("click", ()=>{
      renderCanvasPostSafe();
      showToast("Updated");
    });
    btnFinish.addEventListener("click", ()=> finishMission());
    btnCopyAll.addEventListener("click", ()=> copyText(logText.textContent));
    if(btnCopyPostImage) btnCopyPostImage.addEventListener("click", ()=> copyPostImage());
    if(btnDownloadPostImage) btnDownloadPostImage.addEventListener("click", ()=> downloadPostImage());
    if(btnReRenderPost) btnReRenderPost.addEventListener("click", ()=>{
      renderCanvasPostSafe();
      postStatus.textContent = "Re-rendered";
      showToast("Updated");
    });

    btnStart.addEventListener("click", ()=>{
      setStep(0);
      screenMissions.classList.remove("hidden");
      screenScenario.classList.add("hidden");
      screenSubmit.classList.add("hidden");
      screenSpellbook.classList.add("hidden");
      stopRunTimer();
      window.scrollTo({top:0, behavior:"smooth"});
    });

    btnSpellbook.addEventListener("click", ()=>{
      screenSpellbook.classList.toggle("hidden");
      screenMissions.classList.add("hidden");
      screenScenario.classList.add("hidden");
      screenSubmit.classList.add("hidden");
      renderSpellbook();
      setStep(Math.max(STATE.step, 2));
      window.scrollTo({top:0, behavior:"smooth"});
    });

    btnReset.addEventListener("click", resetAll);

    function resetAll(){
      STATE.step = 0;
      STATE.xp = 0;
      STATE.badges = [];
      STATE.missionId = null;
      STATE.round = 0;
      STATE.decisionLog = [];
      STATE.savedJustifications = [];
      STATE.appliedSpells = [];
      STATE.runStartedAtMs = null;
      STATE.runEndedAtMs = null;
      STATE.streak = 0;
      STATE.runId = null;
      stopRunTimer();
      setStep(0);
      updatePlayerPanel();
      renderMissions();
      updateLog();
      renderCanvasPostSafe();
      screenMissions.classList.remove("hidden");
      screenScenario.classList.add("hidden");
      screenSubmit.classList.add("hidden");
      screenSpellbook.classList.add("hidden");
      showToast("Reset");
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function renderSpellbook(){
      spellbookEl.innerHTML = "";
      SPELLS.forEach(sp=>{
        const wrap = document.createElement("div");
        wrap.className = "spell";
        wrap.innerHTML = `
          <div class="spellTop">
            <div>
              <h4>${sp.title}</h4>
              <small>${sp.subtitle}</small>
            </div>
            <button type="button" class="miniBtn" data-open="${sp.id}">Open</button>
          </div>
          <div class="spellBody" id="body_${sp.id}">
            <p>${sp.body.join(" ")}</p>
            <ul>${sp.prompts.map(p=> `<li>${p}</li>`).join("")}</ul>
            <div class="spellActions">
              <button type="button" class="miniBtn miniBtnGold" data-apply="${sp.id}">Apply Spell</button>
              <button type="button" class="miniBtn" data-close="${sp.id}">Close</button>
            </div>
          </div>
        `;
        spellbookEl.appendChild(wrap);
      });

      spellbookEl.querySelectorAll("button[data-open]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-open");
          el("body_" + id).style.display = "block";
        });
      });
      spellbookEl.querySelectorAll("button[data-close]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-close");
          el("body_" + id).style.display = "none";
        });
      });
      spellbookEl.querySelectorAll("button[data-apply]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-apply");
          const sp = SPELLS.find(s=> s.id === id);
          if(!sp) return;
          if(!STATE.appliedSpells.includes(sp.title)){
            STATE.appliedSpells.push(sp.title);
            addXP(20);
            showToast("Spell applied");
            updateLog();
            renderCanvasPostSafe();
          } else {
            showToast("Already applied");
          }
        });
      });
    }

    // Checkpoint navigation (simple)
    questMap.querySelectorAll(".checkpoint").forEach(cp=>{
      cp.addEventListener("click", ()=>{
        const s = Number(cp.dataset.step);
        if(s === 0){
          screenMissions.classList.remove("hidden");
          screenScenario.classList.add("hidden");
          screenSubmit.classList.add("hidden");
          screenSpellbook.classList.add("hidden");
          setStep(0);
        }
        if(s === 2){
          screenSpellbook.classList.remove("hidden");
          screenMissions.classList.add("hidden");
          screenScenario.classList.add("hidden");
          screenSubmit.classList.add("hidden");
          renderSpellbook();
          setStep(2);
        }
        if(s === 4){
          if(STATE.missionId){
            screenSubmit.classList.remove("hidden");
            screenMissions.classList.add("hidden");
            screenScenario.classList.add("hidden");
            screenSpellbook.classList.add("hidden");
            setStep(4);
          } else {
            showToast("Finish a mission first");
          }
        }
      });
    });

    // Init
    renderMissions();
    setStep(0);
    updatePlayerPanel();
    updateLog();
    renderCanvasPostSafe();
  </script>
</body>
</html>
